name: Run E2E Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  IMAGE_REPO_E2E: my-test

jobs:
  e2e-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Build the cucumber+playwright runtime image
      run: |
        docker buildx build \
          --file Dockerfile \
          --tag ${IMAGE_REPO_E2E}:latest \
          --load .

    - name: Run the BDD test from latest built docker container
      run: |
        docker run -e headless=true ${IMAGE_REPO_E2E}:latest npm run e2e:test

    - name: Upload HTML report
      if: always()  # 无论测试是否失败都执行上传报告的步骤
      uses: actions/upload-artifact@v2
      with:
        name: test-report
        path: reports/report.html  # 替换为实际的 HTML 报告文件路径
